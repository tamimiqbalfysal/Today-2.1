/**
 * @file Firestore Security Rules for Simple Sign Up application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for all user account data. Each user can only access their own data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, where {userId} is the Firebase Auth UID. This path-based structure simplifies authorization.
 *
 * Key Security Decisions:
 * - User listing is denied to prevent unauthorized access to user data.
 * - Only authenticated users can create accounts.
 * - Data validation is limited to ensuring the user ID in the document matches the path. Other schema validation is skipped for prototyping.
 *
 * Denormalization for Authorization:
 * The user's UID is used as the document ID in `/users/{userId}`, which is a form of denormalization. This avoids needing to store the UID redundantly *inside* the document and keeps the security rules simple and efficient.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Enforces access control for user accounts in the /users collection.
     * @path /users/{userId}
     * @allow (get, update, delete) Authenticated user accesses their own account.
     *   Request: auth.uid = "user123", userId = "user123"
     * @allow (create) Authenticated user creates their own account.
     *   Request: auth.uid = "user123", request.resource.data.id = "user123"
     * @deny (get, update, delete) Authenticated user attempts to access another user's account.
     *   Request: auth.uid = "user123", userId = "user456"
     * @deny (create) Authenticated user attempts to create an account with a mismatched user ID.
     *   Request: auth.uid = "user123", request.resource.data.id = "user456"
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && request.resource.data.id == request.auth.uid;
    }

    /**
     * @description Enforces access control for the 'favourites' subcollection using a recursive wildcard.
     * @path /users/{userId}/favourites/{document=**}
     * @allow (read, write) Authenticated user can manage their own favourites.
     *   Example: A user with UID "user123" can read or write to /users/user123/favourites/fav456. This also allows listing the collection.
     * @deny (read, write) A user cannot access another user's favourites.
     *   Example: A user with UID "user123" cannot access /users/user789/favourites/favXYZ.
     * @principle A user can only manage documents within their own 'favourites' subcollection.
     */
    match /users/{userId}/favourites/{document=**} {
      allow read, write: if isOwner(userId);
    }
  }
}
